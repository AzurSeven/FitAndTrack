<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f0f0f">
    <title>Fitness App Pro - V17 (Smart Input)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { app: { bg: '#0f0f0f', card: '#1c1c1e', input: '#2c2c2e', accent: '#8b5cf6', accentDark: '#7c3aed', success: '#22c55e', text: '#e5e5e5', subtext: '#a1a1aa', danger: '#ef4444', topSet: '#ef4444' } },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    padding: { 'safe': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        input, textarea { user-select: text; -webkit-user-select: text; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.25s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .nav-btn { color: #6b7280; transition: all 0.3s ease; }
        .nav-btn.active { color: #8b5cf6 !important; } 
        .nav-btn.active svg { filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.6)); transform: scale(1.15); }
        .btn-validated { background-color: #22c55e !important; color: black !important; border-color: #22c55e !important; transform: scale(0.98); }
        #cloud-toast { transition: opacity 0.3s ease, transform 0.3s ease; }
        .toast-hidden { opacity: 0; transform: translateY(-20px); pointer-events: none; }
        .toast-visible { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="bg-app-bg text-app-text font-sans h-screen flex flex-col overflow-hidden w-full fixed">

    <div id="cloud-toast" class="fixed top-safe mt-4 left-1/2 -translate-x-1/2 z-[110] bg-gray-800 border border-gray-600 px-4 py-2 rounded-full shadow-2xl flex items-center gap-2 toast-hidden backdrop-blur-md">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        <span class="text-xs font-bold text-white">Sauvegarde...</span>
    </div>

    <section id="view-auth" class="fixed inset-0 z-[100] bg-[#0f0f0f] flex flex-col items-center justify-center p-6 transition-all duration-500 overflow-y-auto">
        <div class="w-full max-w-sm text-center space-y-6">
            <h1 class="text-4xl font-black italic text-app-accent mb-8">FITNESS<br><span class="text-white">PRO</span></h1>
            <div id="auth-login-container" class="space-y-4 fade-in">
                <h2 class="text-xl font-bold text-white">Connexion</h2>
                <input type="email" id="login-email" placeholder="Email" class="w-full p-4 rounded-xl bg-app-input border border-gray-700 text-white outline-none focus:border-app-accent text-lg">
                <input type="password" id="login-pass" placeholder="Mot de passe" class="w-full p-4 rounded-xl bg-app-input border border-gray-700 text-white outline-none focus:border-app-accent text-lg">
                <button onclick="loginUser()" class="w-full bg-app-accent hover:bg-app-accentDark text-white font-bold py-4 rounded-xl shadow-lg transition text-lg">Se connecter</button>
                <div class="flex justify-between text-xs text-gray-400 mt-4 px-2"><button onclick="switchAuthMode('register')" class="text-app-accent font-bold p-2">Cr√©er un compte</button></div>
            </div>
            <div id="auth-register-container" class="space-y-3 hidden fade-in">
                <h2 class="text-xl font-bold text-white">Inscription</h2>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="reg-fname" placeholder="Pr√©nom" class="w-full p-4 rounded-xl bg-app-input border border-gray-700 text-white outline-none focus:border-app-accent">
                    <input type="text" id="reg-lname" placeholder="Nom" class="w-full p-4 rounded-xl bg-app-input border border-gray-700 text-white outline-none focus:border-app-accent">
                </div>
                <input type="text" id="reg-pseudo" placeholder="Pseudo" class="w-full p-4 rounded-xl bg-app-input border border-gray-700 text-white outline-none focus:border-app-accent">
                <input type="email" id="reg-email" placeholder="Email" class="w-full p-4 rounded-xl bg-app-input border border-gray-700 text-white outline-none focus:border-app-accent">
                <input type="password" id="reg-pass" placeholder="Mot de passe" class="w-full p-4 rounded-xl bg-app-input border border-gray-700 text-white outline-none focus:border-app-accent">
                <button onclick="registerUser()" class="w-full bg-white text-black font-bold py-4 rounded-xl shadow-lg transition text-lg">S'inscrire</button>
                <div class="text-center text-xs text-gray-400 mt-2">D√©j√† un compte ? <button onclick="switchAuthMode('login')" class="text-app-accent font-bold p-2">Se connecter</button></div>
            </div>
            <p id="auth-message" class="text-sm font-bold text-red-400 mt-4 min-h-[20px]"></p>
        </div>
    </section>

    <header class="sticky top-0 z-50 bg-app-bg/95 backdrop-blur-md p-4 border-b border-gray-800 flex justify-between items-center h-16 pt-safe">
        <h1 id="page-title" class="text-xl font-bold tracking-tight">Accueil</h1>
        <div class="flex items-center gap-3">
            <div id="workout-timer-display" class="hidden bg-gray-800 px-3 py-1 rounded-full border border-gray-700 flex items-center gap-2 cursor-pointer active:opacity-70 transition" onclick="returnToActiveWorkout()">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                <span id="timer-val" class="font-mono font-bold text-sm">00:00</span>
            </div>
        </div>
    </header>

    <main class="flex-grow overflow-y-auto p-4 pb-32 hide-scrollbar relative">
        
        <section id="view-home" class="view-section fade-in">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <p class="text-xs text-gray-400 uppercase font-bold" id="user-role-display">Athl√®te</p>
                    <h2 class="text-2xl font-bold text-white">√Ä faire</h2>
                </div>
            </div>
            <div class="space-y-3" id="home-workouts-list"></div>
        </section>

        <section id="view-library" class="view-section hidden fade-in">
            <div id="coach-selector-container" class="hidden mb-6 bg-app-card p-3 rounded-xl border border-app-accent/30 shadow-lg">
                <label class="text-[10px] text-app-accent uppercase font-bold tracking-wider mb-1 block">Gestion Athl√®te :</label>
                <div class="relative">
                    <select id="coach-athlete-select" onchange="changeCoachTarget()" class="w-full bg-gray-900 text-white text-sm rounded-lg p-3 outline-none border border-gray-700 appearance-none font-bold">
                        <option value="me">üë§ Mon Espace</option>
                    </select>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">‚ñº</div>
                </div>
            </div>
            <div class="mb-4 flex justify-between items-end">
                <div><h2 class="text-2xl font-bold text-white" id="lib-title">Programmes</h2></div>
                <button onclick="switchTab('view-add', null, 'Cr√©ation')" class="bg-app-accent text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg active:scale-95 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                </button>
            </div>
            <div id="lib-list-container" class="space-y-4"></div>
        </section>

        <section id="view-calendar" class="view-section hidden fade-in">
            <div class="bg-app-card rounded-2xl p-4 border border-gray-800 shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4"><h2 class="font-bold text-lg">Calendrier</h2></div>
                <div class="grid grid-cols-7 text-center text-xs text-gray-500 mb-2 font-bold"><div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div><div>D</div></div>
                <div class="grid grid-cols-7 gap-2 text-sm text-center" id="calendar-grid"></div>
            </div>
            <div id="calendar-day-detail" class="fade-in">
                <div class="bg-gray-800/30 border border-dashed border-gray-700 rounded-xl p-6 text-center text-sm text-gray-500">S√©lectionne une date.</div>
            </div>
        </section>

        <section id="view-add" class="view-section hidden fade-in">
            <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
                <label class="text-xs text-app-accent uppercase font-bold tracking-wider" id="add-mode-label">Cr√©er</label>
                <div class="flex gap-2">
                    <span id="add-target-display" class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded">Moi</span>
                    <button onclick="cancelEdit()" id="btn-cancel-edit" class="hidden text-xs text-red-400 border border-red-900/50 px-2 py-1 rounded">‚úï</button>
                </div>
            </div>

            <div id="program-name-container" class="mb-4">
                <input type="text" id="program-name" placeholder="Nom Programme..." class="w-full bg-transparent text-xl font-bold placeholder-gray-600 outline-none text-white">
            </div>

            <div id="added-sessions-list" class="space-y-3 mb-6"></div>

            <div class="bg-app-card p-4 rounded-xl border border-gray-800 relative shadow-lg">
                <div class="space-y-3">
                    <input type="text" id="session-name" placeholder="Nom S√©ance (ex: Pull A)" class="w-full bg-gray-900 rounded-lg p-3 text-sm border border-gray-700 focus:border-app-accent outline-none text-white font-bold">
                    
                    <div id="temp-exercises-list" class="space-y-1"></div>
                    
                    <div class="bg-gray-900/50 rounded-lg p-3 border border-gray-800 space-y-2">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="exo-name" placeholder="Exercice" class="w-full bg-gray-800 rounded p-3 text-sm text-white border border-gray-700 outline-none focus:border-app-accent">
                            <select id="exo-format" class="w-full bg-gray-800 rounded p-3 text-sm text-white border border-gray-700 outline-none font-bold text-app-accent appearance-none">
                                <option value="Straight Set">Straight Set</option>
                                <option value="Top Set">Top Set</option>
                                <option value="Back Off">Back Off</option>
                                <option value="Warm Up">Warm Up</option>
                                <option value="AMRAP">AMRAP</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <input type="number" id="exo-sets" placeholder="S√©ries" class="bg-gray-800 rounded p-2 text-sm text-center text-white border border-gray-700">
                            <input type="text" id="exo-reps" placeholder="Reps" class="bg-gray-800 rounded p-2 text-sm text-center text-white border border-gray-700">
                            <input type="text" id="exo-rest" placeholder="Repos" class="bg-gray-800 rounded p-2 text-sm text-center text-white border border-gray-700">
                            <input type="text" id="exo-rpe" placeholder="RPE" class="bg-gray-800 rounded p-2 text-sm text-center text-white border border-gray-700">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="exo-load" placeholder="Charge (ex: 100kg)" class="w-full bg-gray-800 rounded p-2 text-xs text-white border border-gray-700">
                            <input type="text" id="exo-note" placeholder="Note" class="w-full bg-gray-800 rounded p-2 text-xs text-white border border-gray-700">
                        </div>
                        <button onclick="addExerciseToTemp()" class="w-full bg-gray-700 hover:bg-white hover:text-black text-white text-xs py-3 rounded-lg font-bold transition">+ Ajouter Ligne</button>
                    </div>

                    <button onclick="addSessionToStack()" id="btn-validate-session" class="w-full py-3 bg-app-accent/20 text-app-accent border border-app-accent/50 hover:bg-app-accent hover:text-white text-sm font-bold rounded-lg transition">Valider S√©ance</button>
                </div>
            </div>

            <button type="button" onclick="saveFullProgram()" id="btn-save-program" class="w-full bg-white text-black font-bold py-4 rounded-xl shadow-lg mt-6 mb-safe">Sauvegarder Tout</button>
            <button type="button" onclick="saveEditedSession()" id="btn-update-session" class="hidden w-full bg-green-500 hover:bg-green-400 text-black font-bold py-4 rounded-xl shadow-lg mt-6 mb-safe">Mettre √† jour S√©ance</button>
        </section>

        <section id="view-preview" class="fixed inset-0 bg-app-bg z-[55] p-6 flex flex-col hidden overflow-y-auto">
            <div class="flex justify-between items-center mb-6 pt-safe">
                <button onclick="closePreview()" class="text-gray-400 hover:text-white text-lg">‚úï</button>
                <div class="flex gap-3">
                    <button id="btn-delete-session" onclick="deleteSessionFromPreview()" class="text-app-danger text-xs border border-app-danger/30 px-3 py-2 rounded-lg">Supprimer</button>
                </div>
            </div>
            <div id="preview-badge-coach" class="hidden mb-2"><span class="bg-app-accent text-white text-[10px] font-bold px-2 py-1 rounded uppercase">Coach</span></div>
            <h1 class="text-3xl font-black italic text-white mb-2" id="preview-title">TITRE</h1>
            <div class="space-y-3 mb-8" id="preview-exo-list"></div>
            <button onclick="launchSessionFromPreview()" class="w-full bg-app-accent hover:bg-app-accentDark text-white font-bold py-4 rounded-xl shadow-lg shadow-purple-900/40 mt-auto mb-safe text-lg">COMMENCER</button>
        </section>

        <section id="view-active-workout" class="fixed inset-0 bg-app-bg z-[60] overflow-y-auto hidden">
            <div class="sticky top-0 bg-app-bg/95 backdrop-blur-md border-b border-gray-800 p-4 flex justify-between items-center pt-safe">
                <button onclick="minimizeWorkout()" class="text-gray-400 text-2xl p-2">‚åÑ</button>
                <div class="flex flex-col items-center"><span class="text-xs text-gray-400 font-bold uppercase tracking-wider">Chrono</span><span id="active-timer" class="text-xl font-mono font-bold text-white">00:00</span></div>
                <button onclick="finishWorkout()" class="text-xs bg-app-success text-black font-bold px-4 py-2 rounded-lg uppercase tracking-wide">Finir</button>
            </div>
            <div class="p-4 space-y-6 pb-32" id="active-workout-container"></div>
        </section>

        <section id="view-stats" class="view-section hidden fade-in">
            <h2 class="text-lg font-bold mb-4">Statistiques</h2>
            <div class="bg-app-card p-4 rounded-xl border border-gray-800 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-white">Max Historique</h3>
                    <select id="stats-exo-select" onchange="renderChart()" class="bg-gray-900 text-xs text-white rounded p-1 border border-gray-700 outline-none max-w-[150px]"><option>Chargement...</option></select>
                </div>
                <div class="relative h-64 w-full"><canvas id="progressionChart"></canvas></div>
            </div>
        </section>

        <section id="view-profile" class="view-section hidden fade-in">
            <h2 class="text-lg font-bold mb-4">Profil</h2>
            <div class="bg-app-card rounded-xl p-6 border border-gray-800 mb-6 text-center">
                <div class="w-20 h-20 bg-gradient-to-tr from-purple-500 to-blue-500 rounded-full mx-auto mb-4 flex items-center justify-center text-2xl font-bold text-white shadow-lg" id="profile-avatar">?</div>
                <h3 class="text-2xl font-bold text-white" id="profile-pseudo">...</h3>
                <p class="text-sm text-gray-400 mt-1" id="profile-email">...</p>
                <span id="profile-role-badge" class="mt-3 inline-block bg-gray-800 text-xs px-3 py-1 rounded-full text-app-accent border border-gray-700">Athl√®te</span>
                <button onclick="logout()" class="block w-full mt-6 text-red-400 text-xs border border-red-900/50 px-4 py-3 rounded-lg">D√©connexion</button>
            </div>
            <div id="coach-upgrade-section" class="bg-app-card rounded-xl p-4 border border-gray-800 mb-6">
                <h3 class="text-sm font-bold text-white mb-2">Espace Coach</h3>
                <div class="flex gap-2">
                    <input type="text" id="coach-code-input" placeholder="CODE" class="flex-grow bg-app-input rounded-lg px-3 py-3 text-sm text-white outline-none border border-gray-700">
                    <button onclick="attemptUpgradeCoach()" class="bg-app-accent text-white text-xs font-bold px-4 rounded-lg">OK</button>
                </div>
            </div>
            <div id="coach-team-section" class="hidden bg-app-card rounded-xl p-4 border border-app-accent/30 mb-6">
                <h3 class="text-sm font-bold text-app-accent mb-2">Mon √âquipe</h3>
                <div class="flex gap-2 mb-4">
                    <input type="email" id="invite-email" placeholder="Email" class="flex-grow bg-app-input rounded-lg px-3 py-3 text-sm text-white outline-none border border-gray-700">
                    <button onclick="inviteAthlete()" class="bg-white text-black text-xs font-bold px-4 rounded-lg">Add</button>
                </div>
                <div id="team-list-display" class="space-y-2"></div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 w-full bg-app-card border-t border-gray-800 pb-safe z-40 h-16 shadow-2xl">
        <div class="flex justify-around items-center h-full px-2">
            <button onclick="switchTab('view-calendar', this, 'Calendrier')" id="nav-cal" class="nav-btn p-3 w-1/5 flex justify-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg></button>
            <button onclick="switchTab('view-stats', this, 'Statistiques')" id="nav-stats" class="nav-btn p-3 w-1/5 flex justify-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg></button>
            <button onclick="switchTab('view-home', this, 'Accueil')" id="nav-home" class="nav-btn p-3 w-1/5 flex justify-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg></button>
            <button onclick="switchTab('view-library', this, 'Biblioth√®que')" id="nav-lib" class="nav-btn p-3 w-1/5 flex justify-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg></button>
            <button onclick="switchTab('view-profile', this, 'Profil')" id="nav-prof" class="nav-btn p-3 w-1/5 flex justify-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg></button>
        </div>
    </nav>

    <script>
        const SUPABASE_URL = 'https://nflflxrloaqwnornfvgl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mbGZseHJsb2Fxd25vcm5mdmdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NTUyNjcsImV4cCI6MjA4MDIzMTI2N30.jJ0jqPAJiVdEMLonR6FY3NznKKAtNu-eMFg9yMiH6xg';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        let userData = { profile: {}, team: [], history: {}, stats: { volume: 0, sessions: 0 }, programs: [] };
        let currentCoachTarget = null;
        let chartInstance = null;
        let isEditingMode = false;
        let activeSessionExercises = null;

        // AUTH
        window.onload = async function() {
            switchTab('view-home', document.getElementById('nav-home'), 'Accueil');
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) userConnected(session.user);
        }
        function switchAuthMode(mode) {
            ['auth-login-container', 'auth-register-container'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`auth-${mode}-container`).classList.remove('hidden');
        }
        async function loginUser() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            let { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: pass });
            if (error) document.getElementById('auth-message').innerText = error.message;
            else userConnected(data.user);
        }
        async function registerUser() {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const pseudo = document.getElementById('reg-pseudo').value;
            const fname = document.getElementById('reg-fname').value;
            const lname = document.getElementById('reg-lname').value;
            if(!pseudo || !fname || !lname) return alert("Tous les champs requis");

            const { data, error } = await supabaseClient.auth.signUp({ email, password: pass });
            if (error) document.getElementById('auth-message').innerText = error.message;
            else { 
                if(data.session) {
                    const initData = { profile: { pseudo, nom: lname, prenom: fname, email, role: 'athlete' }, stats: { volume: 0, sessions: 0 }, programs: [], team: [], history: {} };
                    await supabaseClient.from('user_data').upsert({ user_id: data.user.id, content: initData });
                    userConnected(data.user); 
                } else alert("V√©rifie tes mails !"); 
            }
        }
        function userConnected(user) { currentUser = user; document.getElementById('view-auth').classList.add('hidden'); loadUserData(); }
        async function logout() { await supabaseClient.auth.signOut(); window.location.reload(); }

        // DATA
        async function loadUserData() {
            let { data } = await supabaseClient.from('user_data').select('content').eq('user_id', currentUser.id).maybeSingle();
            if (data && data.content) {
                userData = data.content;
                if(!userData.team) userData.team = [];
                if(!userData.history) userData.history = {};
                updateUI();
                if(userData.profile.role === 'coach') populateCoachSelector();
                updateStatsDropdown();
            }
            initCalendar();
        }
        async function syncData(targetUserData = null, targetUserId = null) {
            const t = document.getElementById('cloud-toast');
            t.classList.remove('toast-hidden'); t.classList.add('toast-visible');
            const dataToSave = targetUserData || userData;
            const idToSave = targetUserId || currentUser.id;
            await supabaseClient.from('user_data').upsert({ user_id: idToSave, content: dataToSave }, { onConflict: 'user_id' });
            setTimeout(() => { t.classList.remove('toast-visible'); t.classList.add('toast-hidden'); }, 1000);
        }

        // UI
        function updateUI() {
            const p = userData.profile;
            document.getElementById('user-role-display').innerText = p.role === 'coach' ? 'Coach' : 'Athl√®te';
            document.getElementById('profile-pseudo').innerText = p.pseudo || "Utilisateur";
            document.getElementById('profile-fullname').innerText = `${p.prenom || ''} ${p.nom || ''}`;
            document.getElementById('profile-email').innerText = p.email;
            document.getElementById('profile-avatar').innerText = (p.pseudo || "?")[0].toUpperCase();
            document.getElementById('profile-role-badge').innerText = p.role === 'coach' ? 'Coach' : 'Athl√®te';

            if(p.role === 'coach') {
                document.getElementById('coach-upgrade-section').classList.add('hidden');
                document.getElementById('coach-team-section').classList.remove('hidden');
                document.getElementById('coach-selector-container').classList.remove('hidden');
            } else {
                document.getElementById('coach-upgrade-section').classList.remove('hidden');
                document.getElementById('coach-team-section').classList.add('hidden');
                document.getElementById('coach-selector-container').classList.add('hidden');
            }

            renderProgramLists();
            renderTeamList();
        }

        function renderProgramLists() {
            const libContainer = document.getElementById('lib-list-container');
            const homeList = document.getElementById('home-workouts-list');
            libContainer.innerHTML = '';
            homeList.innerHTML = '';

            const programsToShow = currentCoachTarget ? currentCoachTarget.content.programs : userData.programs;

            if(!programsToShow || programsToShow.length === 0) {
                libContainer.innerHTML = `<div class="text-sm text-gray-500 italic text-center py-4">Aucun programme.</div>`;
                homeList.innerHTML = `<div class="text-center text-gray-500 mt-10">Aucune s√©ance.</div>`;
                return;
            }

            programsToShow.forEach((prog, pIdx) => {
                const isCoachProg = prog.source === 'coach';
                const border = isCoachProg ? 'border-app-accent' : 'border-gray-800';
                const copyBtn = `<button onclick="event.stopPropagation(); duplicateProgram(${pIdx})" class="text-gray-400 hover:text-white ml-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>`;

                libContainer.innerHTML += `
                    <div class="bg-app-card p-4 rounded-xl border ${border} mb-3">
                        <div class="flex justify-between items-center mb-2"><h4 class="font-bold text-white flex items-center">${prog.name} ${renameBtn(pIdx)}</h4><div class="flex items-center">${isCoachProg ? '<span class="text-[10px] bg-app-accent px-2 rounded text-white mr-2">COACH</span>' : ''}${copyBtn}</div></div>
                        <div class="space-y-1">${prog.sessions.map((s, sIdx) => `
                            <div class="flex justify-between items-center bg-gray-900/50 p-3 rounded">
                                <div onclick="openPreview(${pIdx}, ${sIdx})" class="flex-grow text-sm text-gray-400 hover:text-white cursor-pointer">${s.name}</div>
                                <button onclick="editSessionFromList(${pIdx}, ${sIdx})" class="text-xs text-app-accent bg-gray-800 px-2 py-1 rounded ml-2">Modif.</button>
                            </div>`).join('')}</div>
                    </div>`;

                prog.sessions.forEach((s, sIdx) => {
                    homeList.innerHTML += `<div onclick="openPreview(${pIdx}, ${sIdx})" class="bg-app-card p-4 rounded-xl border border-gray-800 flex justify-between items-center cursor-pointer hover:border-app-accent"><div><h4 class="font-bold text-white">${s.name}</h4><p class="text-xs text-gray-500">${prog.name}</p></div><div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center text-gray-400">‚û§</div></div>`;
                });
            });
        }

        function renameBtn(pIdx) { return `<button onclick="event.stopPropagation(); renameProgram(${pIdx})" class="text-gray-400 hover:text-white ml-2">‚úé</button>`; }
        function renameProgram(pIdx) {
            const dataSrc = currentCoachTarget ? currentCoachTarget.content : userData;
            const newName = prompt("Nouveau nom :", dataSrc.programs[pIdx].name);
            if(newName) { dataSrc.programs[pIdx].name = newName; if(currentCoachTarget) syncData(currentCoachTarget.content, currentCoachTarget.user_id); else syncData(); updateUI(); }
        }
        function duplicateProgram(pIdx) {
            const dataSrc = currentCoachTarget ? currentCoachTarget.content : userData;
            const copy = JSON.parse(JSON.stringify(dataSrc.programs[pIdx]));
            copy.name += " (Copie)";
            dataSrc.programs.push(copy);
            if(currentCoachTarget) syncData(currentCoachTarget.content, currentCoachTarget.user_id); else syncData();
            updateUI();
        }

        function renderTeamList() {
            document.getElementById('team-list-display').innerHTML = userData.team.map(m => `<div class="text-xs text-gray-300 bg-gray-800 p-2 rounded flex justify-between items-center border border-gray-700"><div><span class="font-bold block">${m.prenom} ${m.nom}</span><span class="text-gray-500">${m.email}</span></div></div>`).join('');
        }

        // COACHING
        function attemptUpgradeCoach() { if(document.getElementById('coach-code-input').value === "SUPACOACH") { userData.profile.role = 'coach'; syncData(); updateUI(); alert("Mode Coach !"); } }
        async function inviteAthlete() {
            const email = document.getElementById('invite-email').value;
            if(!email) return;
            let { data } = await supabaseClient.from('user_data').select('user_id, content').contains('content', { profile: { email: email } }).maybeSingle();
            if(data) {
                const p = data.content.profile;
                if(userData.team.some(m => m.uid === data.user_id)) return alert("D√©j√† dans l'√©quipe");
                userData.team.push({ email: p.email, nom: p.nom, prenom: p.prenom, uid: data.user_id });
                syncData(); updateUI(); populateCoachSelector(); document.getElementById('invite-email').value = '';
                alert(`${p.prenom} ajout√© !`);
            } else { alert("Aucun compte trouv√© avec cet email."); }
        }
        function populateCoachSelector() {
            const sel = document.getElementById('coach-athlete-select');
            sel.innerHTML = '<option value="me">üë§ Mon Espace Perso</option>';
            userData.team.forEach(m => { sel.innerHTML += `<option value="${m.uid}">üèÉ ${m.prenom} ${m.nom}</option>`; });
        }
        async function changeCoachTarget() {
            const targetId = document.getElementById('coach-athlete-select').value;
            if(targetId === 'me') { currentCoachTarget = null; document.getElementById('lib-title').innerText = "Mes Programmes"; updateUI(); } 
            else {
                let { data } = await supabaseClient.from('user_data').select('user_id, content').eq('user_id', targetId).single();
                if(data) { currentCoachTarget = data; document.getElementById('lib-title').innerText = "Prog. de " + data.content.profile.prenom; renderProgramLists(); }
            }
        }

        // CREATION & EDIT (SMART)
        let tempSessionStack = [], tempExercises = [];
        
        function addExerciseToTemp() {
            const name = document.getElementById('exo-name').value;
            const format = document.getElementById('exo-format').value;
            
            if(!name) return;
            
            tempExercises.push({ name, format, sets: document.getElementById('exo-sets').value, reps: document.getElementById('exo-reps').value, rest: document.getElementById('exo-rest').value, rpe: document.getElementById('exo-rpe').value, load: document.getElementById('exo-load').value, note: document.getElementById('exo-note').value });
            renderTempExos();

            // LOGIC SMART FILL
            if(format === "Top Set") {
                // Keep name, Switch to Back Off, Clear Load
                document.getElementById('exo-format').value = "Back Off";
                document.getElementById('exo-sets').value = "";
                document.getElementById('exo-load').value = "";
            } else {
                // Clear Name & Format
                document.getElementById('exo-name').value = "";
                document.getElementById('exo-format').value = "Straight Set";
                document.getElementById('exo-sets').value = "";
                document.getElementById('exo-load').value = "";
            }
        }
        
        function renderTempExos() { document.getElementById('temp-exercises-list').innerHTML = tempExercises.map(e=>`<div class="text-xs text-gray-400 border-l-2 border-app-accent pl-2 mb-1 flex justify-between"><span>${e.name} <span class="text-app-topSet font-bold">${e.format || ''}</span></span><span class="text-gray-600">${e.sets}x${e.reps}</span></div>`).join(''); }

        function addSessionToStack() { const name = document.getElementById('session-name').value; if(!name) return; tempSessionStack.push({name, exercises: [...tempExercises]}); tempExercises = []; renderTempExos(); document.getElementById('session-name').value = ''; document.getElementById('added-sessions-list').innerHTML = tempSessionStack.map(s=>`<div class="bg-gray-800 p-2 rounded text-sm text-white">${s.name}</div>`).join(''); }
        
        async function saveFullProgram() {
            const name = document.getElementById('program-name').value; if(!name || tempSessionStack.length === 0) return alert("Incomplet");
            const newProg = { name: name, source: currentCoachTarget ? 'coach' : 'personal', sessions: tempSessionStack };
            if(currentCoachTarget) { currentCoachTarget.content.programs.push(newProg); await syncData(currentCoachTarget.content, currentCoachTarget.user_id); alert("Envoy√©"); } else { userData.programs.push(newProg); syncData(); }
            resetAddView(); switchTab('view-library', null, 'Biblioth√®que');
        }

        // EDIT SESSION DIRECTLY
        function editSessionFromList(pIdx, sIdx) {
            currentProgramIndex = pIdx; currentPreviewSessionIndex = sIdx;
            const dataSrc = currentCoachTarget ? currentCoachTarget.content : userData;
            const sess = dataSrc.programs[pIdx].sessions[sIdx];
            isEditingMode = true;
            document.getElementById('session-name').value = sess.name;
            tempExercises = [...sess.exercises]; renderTempExos();
            document.getElementById('program-name-container').classList.add('hidden'); document.getElementById('added-sessions-list').classList.add('hidden'); document.getElementById('btn-validate-session').classList.add('hidden'); document.getElementById('btn-save-program').classList.add('hidden');
            document.getElementById('btn-update-session').classList.remove('hidden'); document.getElementById('btn-cancel-edit').classList.remove('hidden');
            document.getElementById('add-mode-label').innerText = "Modifier";
            switchTab('view-add', null, 'Modification');
        }
        async function saveEditedSession() {
            const newName = document.getElementById('session-name').value; if(!newName) return alert("Nom requis");
            const dataSrc = currentCoachTarget ? currentCoachTarget.content : userData; const userId = currentCoachTarget ? currentCoachTarget.user_id : currentUser.id;
            dataSrc.programs[currentProgramIndex].sessions[currentPreviewSessionIndex] = { name: newName, exercises: [...tempExercises] };
            await syncData(dataSrc, userId); alert("S√©ance mise √† jour !"); resetAddView(); switchTab('view-library', null, 'Biblioth√®que');
        }
        function cancelEdit() { resetAddView(); switchTab('view-library', null, 'Biblioth√®que'); }
        function resetAddView() { isEditingMode = false; tempSessionStack = []; tempExercises = []; document.getElementById('session-name').value = ''; document.getElementById('program-name').value = ''; renderTempExos(); document.getElementById('added-sessions-list').innerHTML = ''; document.getElementById('program-name-container').classList.remove('hidden'); document.getElementById('added-sessions-list').classList.remove('hidden'); document.getElementById('btn-validate-session').classList.remove('hidden'); document.getElementById('btn-save-program').classList.remove('hidden'); document.getElementById('btn-update-session').classList.add('hidden'); document.getElementById('btn-cancel-edit').classList.add('hidden'); document.getElementById('add-mode-label').innerText = "Cr√©er"; }

        // PREVIEW
        let currentProgramIndex, currentPreviewSessionIndex;
        function openPreview(pIdx, sIdx) {
            currentProgramIndex = pIdx; currentPreviewSessionIndex = sIdx;
            const dataSrc = currentCoachTarget ? currentCoachTarget.content : userData; const sess = dataSrc.programs[pIdx].sessions[sIdx];
            document.getElementById('preview-title').innerText = sess.name;
            const btnDel = document.getElementById('btn-delete-session');
            if(dataSrc.programs[pIdx].source === 'coach' && userData.profile.role !== 'coach') btnDel.classList.add('hidden'); else btnDel.classList.remove('hidden');
            document.getElementById('preview-exo-list').innerHTML = sess.exercises.map(e => `
                <div class="bg-gray-800 rounded p-3 border border-gray-700">
                    <div class="flex justify-between items-start mb-1">
                        <div><span class="font-bold text-white text-lg block">${e.name}</span><span class="${e.format==='Top Set'?'text-app-topSet':'text-gray-400'} text-xs font-bold uppercase">${e.format || ''}</span></div>
                        <span class="text-xs bg-gray-700 px-2 rounded text-gray-300">RPE ${e.rpe}</span>
                    </div>
                    <div class="text-xs text-gray-400">${e.sets} x ${e.reps} ‚Ä¢ ${e.rest}</div>
                </div>`).join('');
            document.getElementById('view-preview').classList.remove('hidden');
        }
        function closePreview() { document.getElementById('view-preview').classList.add('hidden'); }
        async function deleteSessionFromPreview() { if(!confirm("Supprimer ?")) return; const dataSrc = currentCoachTarget ? currentCoachTarget.content : userData; dataSrc.programs[currentProgramIndex].sessions.splice(currentPreviewSessionIndex, 1); if(dataSrc.programs[currentProgramIndex].sessions.length === 0) dataSrc.programs.splice(currentProgramIndex, 1); await syncData(dataSrc, currentCoachTarget?.user_id); updateUI(); closePreview(); }
        function launchSessionFromPreview() { const dataSrc = currentCoachTarget ? currentCoachTarget.content : userData; startWorkout(dataSrc.programs[currentProgramIndex].sessions[currentPreviewSessionIndex]); closePreview(); }

        // WORKOUT
        let workoutInterval;
        function startWorkout(sess) {
            activeSessionExercises = sess.exercises;
            document.getElementById('view-active-workout').classList.remove('hidden');
            document.getElementById('workout-timer-display').classList.remove('hidden');
            document.getElementById('active-workout-container').innerHTML = `<h2 class="text-2xl text-white font-bold mb-6">${sess.name}</h2>` + 
                sess.exercises.map((exo, idx) => {
                    let rows = ''; for(let i=1; i<=exo.sets; i++) rows += `<div class="grid grid-cols-10 gap-2 items-center mb-2" id="set-row-${idx}-${i}"><div class="col-span-1 text-center font-bold text-gray-500">${i}</div><div class="col-span-3"><input type="number" class="w-full bg-gray-900 rounded border border-gray-700 text-center py-3 text-white font-bold text-lg" placeholder="${exo.load || '-'}"></div><div class="col-span-3"><input type="number" class="w-full bg-gray-900 rounded border border-gray-700 text-center py-3 text-white font-bold text-lg" placeholder="${exo.reps}"></div><div class="col-span-3 flex justify-center"><button onclick="validateSet(this, ${idx}, ${i})" class="w-full bg-gray-800 text-gray-400 rounded py-3 transition font-bold text-sm border border-gray-600">RPE</button></div></div>`;
                    return `<div class="bg-app-card rounded-xl border border-gray-800 overflow-hidden mb-6"><div class="bg-gray-800/50 p-3 border-b border-gray-800"><div class="flex justify-between items-center mb-1"><h3 class="font-bold text-lg text-white">${exo.name}</h3><span class="${exo.format==='Top Set'?'text-app-topSet':'text-gray-400'} text-xs font-bold uppercase">${exo.format || ''}</span></div><div class="flex gap-4 text-xs text-gray-400"><span>Obj: ${exo.load || '-'}</span><span>${exo.sets}x${exo.reps}</span><span>RPE ${exo.rpe}</span></div></div><div class="p-3"><div class="grid grid-cols-10 gap-2 text-[10px] text-gray-500 mb-2 text-center uppercase font-bold tracking-wider"><div class="col-span-1">#</div><div class="col-span-3">KG</div><div class="col-span-3">REPS</div><div class="col-span-3">RPE</div></div>${rows}</div></div>`;
                }).join('');
            let sec = 0; clearInterval(workoutInterval); workoutInterval = setInterval(() => { sec++; document.getElementById('active-timer').innerText = new Date(sec * 1000).toISOString().substr(14, 5); document.getElementById('timer-val').innerText = document.getElementById('active-timer').innerText; }, 1000);
        }
        function validateSet(btn, exoIdx, setIdx) { 
            const rpe = prompt("RPE (1-10)?", "8"); 
            if(rpe) { 
                btn.innerText = "‚úì"; btn.className = "w-full rounded py-3 font-bold text-sm btn-validated";
                const row = document.getElementById(`set-row-${exoIdx}-${setIdx}`); 
                row.dataset.performed = JSON.stringify({ kg: row.querySelectorAll('input')[0].value || 0, reps: row.querySelectorAll('input')[1].value || 0, rpe }); 
            } 
        }
        function finishWorkout() {
            if(!confirm("Terminer ?")) return; clearInterval(workoutInterval); document.getElementById('view-active-workout').classList.add('hidden'); document.getElementById('workout-timer-display').classList.add('hidden');
            let vol = 0; const dateKey = new Date().toISOString().split('T')[0];
            const sessionRes = { title: document.querySelector('#active-workout-container h2').innerText, duration: document.getElementById('active-timer').innerText, exercises: [] };
            activeSessionExercises.forEach((baseExo, idx) => {
                const exoRes = { name: baseExo.name, sets: [], max: 0 };
                document.querySelectorAll(`[id^="set-row-${idx}-"]`).forEach(row => { 
                    if(row.dataset.performed) { 
                        const p = JSON.parse(row.dataset.performed); 
                        vol += parseFloat(p.kg) * parseFloat(p.reps); 
                        exoRes.sets.push(p);
                        if(parseFloat(p.kg) > exoRes.max) exoRes.max = parseFloat(p.kg);
                    } 
                });
                if(exoRes.sets.length > 0) sessionRes.exercises.push(exoRes);
            });
            if(!userData.history[dateKey]) userData.history[dateKey] = []; userData.history[dateKey].push(sessionRes);
            userData.stats.sessions++; userData.stats.volume += vol;
            syncData(); updateUI(); updateStatsDropdown(); switchTab('view-stats', null, 'Statistiques');
        }
        function minimizeWorkout() { document.getElementById('view-active-workout').classList.add('hidden'); }
        function returnToActiveWorkout() { document.getElementById('view-active-workout').classList.remove('hidden'); }

        // CHARTS & CALENDAR DETAILS
        function updateStatsDropdown() {
            const sel = document.getElementById('stats-exo-select'); sel.innerHTML = '<option>Choisir...</option>'; const exos = new Set();
            Object.values(userData.history).flat().forEach(s => { if(s.exercises) s.exercises.forEach(e => exos.add(e.name)) });
            exos.forEach(name => sel.innerHTML += `<option>${name}</option>`);
        }
        function renderChart() { 
            const exoName = document.getElementById('stats-exo-select').value; const ctx = document.getElementById('progressionChart').getContext('2d');
            const dataPoints = []; Object.entries(userData.history).forEach(([date, sessions]) => { sessions.forEach(sess => { if(sess.exercises) { const exoData = sess.exercises.find(e => e.name === exoName); if(exoData) dataPoints.push({ x: date, y: exoData.max }); } }); });
            dataPoints.sort((a,b) => new Date(a.x) - new Date(b.x));
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: dataPoints.map(d => d.x), datasets: [{ label: 'Max (kg)', data: dataPoints.map(d => d.y), borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', tension: 0.3, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, grid: { color: '#374151' }, ticks: { color: '#9ca3af' } }, x: { grid: { display: false }, ticks: { color: '#9ca3af' } } } } });
        }

        // UTILS
        function switchTab(viewId, btnElement, title) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden')); document.getElementById(viewId).classList.remove('hidden'); document.getElementById('page-title').innerText = title;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active')); if(btnElement) btnElement.classList.add('active');
            const addBtn = document.getElementById('header-add-btn'); if(viewId === 'view-library') addBtn.classList.remove('hidden'); else addBtn.classList.add('hidden');
            if(viewId === 'view-add') document.getElementById('add-target-display').innerText = currentCoachTarget ? currentCoachTarget.content.profile.prenom : "Moi-m√™me";
        }
        function initCalendar() {
            const grid = document.getElementById('calendar-grid'); grid.innerHTML = ''; for(let i=0; i<2; i++) grid.innerHTML += `<div></div>`;
            const yearMonth = new Date().toISOString().slice(0, 7);
            for(let i=1; i<=31; i++) {
                const k = `${yearMonth}-${String(i).padStart(2, '0')}`;
                const hasWork = userData.history[k];
                grid.innerHTML += `<div onclick="showDayDetails('${k}')" class="p-2 rounded-lg cursor-pointer hover:bg-gray-800 ${hasWork?'text-white font-bold':'text-gray-600'} ${i===new Date().getDate()?'border border-app-accent':''}">${i} ${hasWork?'<div class="w-1 h-1 bg-app-success rounded-full mx-auto"></div>':''}</div>`;
            }
        }
        function showDayDetails(k) {
            const s = userData.history[k]; const b = document.getElementById('calendar-day-detail');
            if(s) b.innerHTML = s.map(sess => {
                const details = sess.exercises.map(e => `<div class="flex justify-between text-xs text-gray-400 border-b border-gray-700 pb-1"><span>${e.name}</span><span>Max: ${e.max}kg (${e.sets.length} sets)</span></div>`).join('');
                return `<div class="bg-gray-800 p-4 rounded-xl border border-gray-700 mb-2"><div class="flex justify-between mb-2"><span class="text-app-success font-bold text-xs">‚úì Termin√©</span><span class="text-gray-500 text-xs">${sess.duration}</span></div><div class="text-white font-bold mb-2">${sess.title}</div><div class="space-y-1">${details}</div></div>`;
            }).join('');
            else b.innerHTML = `<div class="bg-gray-800/30 border border-dashed border-gray-700 rounded-xl p-6 text-center text-sm text-gray-500">Rien ce jour-l√†.</div>`;
        }
    </script>
</body>
</html>
